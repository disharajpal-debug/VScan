<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Cards</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; }
        .table-wrap { max-width: 1200px; margin: 0 auto; }
    </style>
</head>
<body>
    <div class="table-wrap">
        <h2>Admin Dashboard â€” All Cards</h2>
        <div class="mb-3">
            <button id="refreshBtn" class="btn btn-sm btn-primary">Refresh</button>
            <button id="exportBtn" class="btn btn-sm btn-success">Export CSV</button>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-bordered" id="adminCardsTable">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Company</th>
                        <th>Designation</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Website</th>
                        <th>Scanned By</th>
                        <th>Shared</th>
                        <th>Uploaded At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="adminCardsBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        async function fetchCards() {
            const res = await fetch('/cards');
            const data = await res.json();
            if (!data.success) {
                alert('Failed to load cards: ' + (data.error || 'unknown'));
                return [];
            }
            return data.cards || [];
        }

        function renderTable(cards) {
            const tbody = document.getElementById('adminCardsBody');
            tbody.innerHTML = '';
            if (!cards.length) {
                tbody.innerHTML = '<tr><td colspan="11" class="text-center">No cards found</td></tr>';
                return;
            }
            for (const c of cards) {
                const tr = document.createElement('tr');
                const uploaded = c.uploaded_at ? (new Date(c.uploaded_at)).toLocaleString() : '';
                tr.innerHTML = `
                    <td>${c._id}</td>
                    <td>${c.name || ''}</td>
                    <td>${c.company || ''}</td>
                    <td>${c.designation || ''}</td>
                    <td>${c.email || ''}</td>
                    <td>${c.phone || ''}</td>
                    <td>${c.website || ''}</td>
                    <td>${c.scanned_by || ''}</td>
                    <td>${c.shared ? 'Yes' : 'No'}</td>
                    <td>${uploaded}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteCard('${c._id}')">Delete</button>
                        <button class="btn btn-sm btn-warning" onclick="toggleShare('${c._id}')">Toggle Share</button>
                    </td>
                `;
                tbody.appendChild(tr);
            }
        }

        async function loadAndRender() {
            const cards = await fetchCards();
            renderTable(cards.map(c => ({
                ...c,
                // uploaded_at may be an object; try to read ISO if present
                uploaded_at: typeof c.uploaded_at === 'string' ? c.uploaded_at : (c.uploaded_at && c.uploaded_at.$date) ? c.uploaded_at.$date : c.uploaded_at
            })));
        }

        async function deleteCard(id) {
            if (!confirm('Delete card ' + id + '?')) return;
            const res = await fetch('/delete_card/' + id, { method: 'DELETE' });
            const j = await res.json();
            if (j.success) { loadAndRender(); alert('Deleted'); }
            else alert('Failed: ' + (j.error || 'unknown'));
        }

        async function toggleShare(id) {
            const res = await fetch('/share_card/' + id, { method: 'POST' });
            const j = await res.json();
            if (j.success) { loadAndRender(); }
            else alert('Failed to toggle share: ' + (j.error || 'unknown'));
        }

        document.getElementById('refreshBtn').addEventListener('click', loadAndRender);
        document.getElementById('exportBtn').addEventListener('click', () => {
            // Trigger server CSV download
            window.location.href = '/admin/export_csv';
        });

        // Initial load
        loadAndRender();
    </script>
</body>
</html>
